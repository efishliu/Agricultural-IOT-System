###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.1.10194/W32 for 8051         10/Jul/2018  15:41:16 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Com #
#                          ponents\mt\MT_SYS.c                                #
#    Command line       =  -f E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\ #
#                          Projects\zstack\Utilities\SerialApp\CC2530DB\..\.. #
#                          \..\Tools\CC2530DB\f8wRouter.cfg (-DCPU32MHZ       #
#                          -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                          E -DRTR_NWK -DBLINK_LEDS) -f                       #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \Tools\CC2530DB\f8wConfig.cfg (-DSECURE=0          #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFF1                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE     #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100) -DREJOIN_POLL_RATE=440   #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Com #
#                          ponents\mt\MT_SYS.c -D ZIGBEEPRO -D HAL_UART=TRUE  #
#                          -D SERIAL_APP_PORT=0 -D LCD_SUPPORTED -lC          #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\RouterEB #
#                          -Pro\List\ -lA E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú #
#                          \WSN_ZigBee\Projects\zstack\Utilities\SerialApp\CC #
#                          2530DB\RouterEB-Pro\List\ --diag_suppress          #
#                          Pe001,Pa010 -o E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú #
#                          \WSN_ZigBee\Projects\zstack\Utilities\SerialApp\CC #
#                          2530DB\RouterEB-Pro\Obj\ -e --debug --core=plain   #
#                          --dptr=16,1 --data_model=large                     #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 8 -I E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\À #
#                          ý³Ì\Ë«»ú\WSN_ZigBee\Projects\zstack\Utilities\Seri #
#                          alApp\CC2530DB\ -I E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\ #
#                          Ë«»ú\WSN_ZigBee\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\..\SOURCE\ -I                           #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \ZMAIN\TI2530DB\ -I E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì #
#                          \Ë«»ú\WSN_ZigBee\Projects\zstack\Utilities\SerialA #
#                          pp\CC2530DB\..\..\..\..\..\COMPONENTS\MT\ -I       #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\HAL\INCLUDE\ -I                  #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\HAL\TARGET\CC2530EB\ -I          #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\OSAL\MCU\CCSOC\ -I               #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\OSAL\INCLUDE\ -I                 #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\STACK\AF\ -I                     #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\STACK\NWK\ -I                    #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\STACK\SEC\ -I                    #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\STACK\SAPI\ -I                   #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\STACK\SYS\ -I                    #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\STACK\ZDO\ -I                    #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\ZMAC\F8W\ -I                     #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\ZMAC\ -I                         #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\SERVICES\SADDR\ -I               #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\SERVICES\SDATA\ -I               #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\MAC\INCLUDE\ -I                  #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\MAC\HIGH_LEVEL\ -I               #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\MAC\LOW_LEVEL\srf04\ -I          #
#                          E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\..\..\.. #
#                          \..\..\COMPONENTS\MAC\LOW_LEVEL\srf04\SINGLE_CHIP\ #
#                           -Ohz --require_prototypes                         #
#    List file          =  E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\RouterEB #
#                          -Pro\List\MT_SYS.lst                               #
#    Object file        =  E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Pro #
#                          jects\zstack\Utilities\SerialApp\CC2530DB\RouterEB #
#                          -Pro\Obj\MT_SYS.r51                                #
#                                                                             #
#                                                                             #
###############################################################################

E:\123\´óÈý\Éú²úÊµÏ°\Àý³Ì\Àý³Ì\Ë«»ú\WSN_ZigBee\Components\mt\MT_SYS.c
      1          /***************************************************************************************************
      2            Filename:       MT.c
      3            Revised:        $Date: 2009-03-12 16:25:22 -0700 (Thu, 12 Mar 2009) $
      4            Revision:       $Revision: 19404 $
      5          
      6            Description:   MonitorTest
      7          
      8            Copyright 2007 Texas Instruments Incorporated. All rights reserved.
      9          
     10            IMPORTANT: Your use of this Software is limited to those specific rights
     11            granted under the terms of a software license agreement between the user
     12            who downloaded the software, his/her employer (which must be your employer)
     13            and Texas Instruments Incorporated (the "License").  You may not use this
     14            Software unless you agree to abide by the terms of the License. The License
     15            limits your use, and you acknowledge, that the Software may not be modified,
     16            copied or distributed unless embedded on a Texas Instruments microcontroller
     17            or used solely and exclusively in conjunction with a Texas Instruments radio
     18            frequency transceiver, which is integrated into your product.  Other than for
     19            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     20            works of, modify, distribute, perform, display or sell this Software and/or
     21            its documentation for any purpose.
     22          
     23            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     24            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     25            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     26            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     27            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     28            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     29            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     30            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     31            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     32            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     33            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     34          
     35            Should you have any questions regarding your right to use this Software,
     36            contact Texas Instruments Incorporated at www.TI.com.
     37          
     38           ***************************************************************************************************/
     39          
     40          /***************************************************************************************************
     41           * INCLUDES
     42           ***************************************************************************************************/
     43          #include "ZComDef.h"
     44          #include "MT.h"
     45          #include "MT_SYS.h"
     46          #include "MT_VERSION.h"
     47          #include "nwk_util.h"
     48          #include "OSAL_NV.h"
     49          #include "Onboard.h"  /* This is here because RAM read/write macros need it */

   \                                 In  segment SFR_AN, at 0x9d
   \   unsigned char volatile __sfr SLEEPSTA
   \                     SLEEPSTA:
   \   000000                DS 1
     50          #include "hal_adc.h"
     51          #include "ZGlobals.h"
     52          
     53          #include "Osal_Memory.h"
     54          #include "OSAL.h"
     55          
     56          /***************************************************************************************************
     57           * MACROS
     58           ***************************************************************************************************/
     59          
     60          #define MT_SYS_DEVICE_INFO_RESPONSE_LEN 14
     61          #define MT_NV_ITEM_MAX_LENGTH           250
     62          
     63          /***************************************************************************************************
     64           * CONSTANT
     65           ***************************************************************************************************/

   \                                 In  segment XDATA_ROM_C, align 1
     66          const uint16 MT_SysOsalEventId [] = {
   \                     MT_SysOsalEventId:
   \   000000   0008         DW 2048
   \   000002   0004         DW 1024
   \   000004   0002         DW 512
   \   000006   0001         DW 256
     67                                                MT_SYS_OSAL_EVENT_0,
     68                                                MT_SYS_OSAL_EVENT_1,
     69                                                MT_SYS_OSAL_EVENT_2,
     70                                                MT_SYS_OSAL_EVENT_3
     71                                              };
     72          
     73          typedef enum {
     74            GPIO_DIR,
     75            GPIO_TRI,
     76            GPIO_SET,
     77            GPIO_CLR,
     78            GPIO_TOG,
     79            GPIO_GET,
     80            GPIO_HiD = 0x12
     81          } GPIO_Op_t;
     82          
     83          #define GPIO_MASK  0x33
     84          
     85          /***************************************************************************************************
     86           * EXTERNAL FUNCTIONS
     87           ***************************************************************************************************/
     88          extern uint16 HalAdcReadVoltage(void);
     89          extern uint16 HalAdcReadTemperature(void);
     90          
     91          /***************************************************************************************************
     92           * LOCAL FUNCTIONS
     93           ***************************************************************************************************/
     94          #if defined (MT_SYS_FUNC)
     95          void MT_SysReset(uint8 *pBuf);
     96          void MT_SysPing(void);
     97          void MT_SysVersion(void);
     98          void MT_SysSetExtAddr(uint8 *pBuf);
     99          void MT_SysGetExtAddr(void);
    100          void MT_SysOsalNVWrite(uint8 *pBuf);
    101          void MT_SysOsalNVRead(uint8 *pBuf);
    102          void MT_SysOsalStartTimer(uint8 *pBuf);
    103          void MT_SysOsalStopTimer(uint8 *pBuf);
    104          void MT_SysRandom(void);
    105          void MT_SysAdcRead(uint8 *pBuf);
    106          void MT_SysGpio(uint8 *pBuf);
    107          void MT_SysGetDeviceInfo(uint8 *pBuf);
    108          #endif /* MT_SYS_FUNC */
    109          
    110          #if defined (MT_SYS_FUNC)
    111          /***************************************************************************************************
    112           * @fn      MT_SysProcessing
    113           *
    114           * @brief   Process all the SYS commands that are issued by test tool
    115           *
    116           * @param   pBuf - pointer to the msg buffer
    117           *
    118           *          | LEN  | CMD0  | CMD1  |  DATA  |
    119           *          |  1   |   1   |   1   |  0-255 |
    120           *
    121           * @return  status
    122           ***************************************************************************************************/
    123          uint8 MT_SysCommandProcessing(uint8 *pBuf)
    124          {
    125            uint8 status = MT_RPC_SUCCESS;
    126          
    127            switch (pBuf[MT_RPC_POS_CMD1])
    128            {
    129              case MT_SYS_RESET_REQ:
    130                MT_SysReset(pBuf);
    131                break;
    132          
    133              case MT_SYS_PING:
    134                MT_SysPing();
    135                break;
    136          
    137              case MT_SYS_VERSION:
    138                MT_SysVersion();
    139                break;
    140          
    141              case MT_SYS_SET_EXTADDR:
    142                MT_SysSetExtAddr(pBuf);
    143                break;
    144          
    145              case MT_SYS_GET_EXTADDR:
    146                MT_SysGetExtAddr();
    147                break;
    148          
    149              case MT_SYS_OSAL_NV_READ:
    150                MT_SysOsalNVRead(pBuf);
    151                break;
    152          
    153              case MT_SYS_OSAL_NV_WRITE:
    154                MT_SysOsalNVWrite(pBuf);
    155                break;
    156          
    157              case MT_SYS_OSAL_START_TIMER:
    158                MT_SysOsalStartTimer(pBuf);
    159                break;
    160          
    161              case MT_SYS_OSAL_STOP_TIMER:
    162                MT_SysOsalStopTimer(pBuf);
    163                break;
    164          
    165              case MT_SYS_RANDOM:
    166                MT_SysRandom();
    167                break;
    168          
    169              case MT_SYS_ADC_READ:
    170                MT_SysAdcRead(pBuf);
    171                break;
    172          
    173              case MT_SYS_GPIO:
    174                MT_SysGpio(pBuf);
    175                break;
    176          
    177              case MT_SYS_RESET_IND:
    178                //TBD
    179                break;
    180          
    181              default:
    182                status = MT_RPC_ERR_COMMAND_ID;
    183                break;
    184            }
    185          
    186            return status;
    187          }
    188          
    189          /***************************************************************************************************
    190           * @fn      MT_SysReset
    191           *
    192           * @brief   Reset/reprogram the device.
    193           * @param   typID: 0=reset, 1=serial bootloader
    194           *
    195           * @return  None
    196           ***************************************************************************************************/
    197          void MT_SysReset(uint8 *pBuf)
    198          {
    199            (void)pBuf;  // Intentionally unreferenced parameter
    200            SystemReset();  /* Restart this program */
    201          }
    202          
    203          /***************************************************************************************************
    204           * @fn      MT_SysPing
    205           *
    206           * @brief   Process the Ping command
    207           *
    208           * @param   None
    209           *
    210           * @return  None
    211           ***************************************************************************************************/
    212          void MT_SysPing(void)
    213          {
    214            uint16 tmp16;
    215            uint8 retArray[2];
    216          
    217            /* Build Capabilities */
    218            tmp16 = MT_CAP_SYS | MT_CAP_MAC | MT_CAP_NWK | MT_CAP_AF | MT_CAP_ZDO|
    219                    MT_CAP_SAPI | MT_CAP_UTIL | MT_CAP_DEBUG | MT_CAP_APP | MT_CAP_ZOAD;
    220          
    221            /* Convert to high byte first into temp buffer */
    222            retArray[0] = LO_UINT16( tmp16 );
    223            retArray[1] = HI_UINT16( tmp16 );
    224          
    225            /* Build and send back the response */
    226            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), MT_SYS_PING,
    227                                          sizeof (tmp16), retArray );
    228          }
    229          
    230          /***************************************************************************************************
    231           * @fn      MT_SysVersion
    232           *
    233           * @brief   Process the Version command
    234           *
    235           * @param   None
    236           *
    237           * @return  None
    238           ***************************************************************************************************/
    239          void MT_SysVersion(void)
    240          {
    241            byte *verStr = (byte *)MTVersionString;
    242            uint8 respLen = sizeof(MTVersionString);
    243          
    244            /* Build and send back the response */
    245            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), MT_SYS_VERSION,
    246                                         respLen, verStr);
    247          }
    248          
    249          /***************************************************************************************************
    250           * @fn      MT_SysSetExtAddr
    251           *
    252           * @brief   Set the Extended Address
    253           *
    254           * @param   pBuf
    255           *
    256           * @return  None
    257           ***************************************************************************************************/
    258          void MT_SysSetExtAddr(uint8 *pBuf)
    259          {
    260            uint8 retValue = ZFailure;
    261            uint8 cmdId;
    262          
    263            /* parse header */
    264            cmdId = pBuf[MT_RPC_POS_CMD1];
    265            pBuf += MT_RPC_FRAME_HDR_SZ;
    266          
    267            if ( ZMacSetReq(ZMacExtAddr, pBuf) == ZMacSuccess )
    268            {
    269              retValue = osal_nv_write(ZCD_NV_EXTADDR, 0, Z_EXTADDR_LEN, pBuf);
    270            }
    271          
    272            /* Build and send back the response */
    273            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), cmdId, 1, &retValue);
    274          
    275          }
    276          
    277          /***************************************************************************************************
    278           * @fn      MT_SysVersion
    279           *
    280           * @brief   Process the Version command
    281           *
    282           * @param   None
    283           *
    284           * @return  None
    285           ***************************************************************************************************/
    286          void MT_SysGetExtAddr(void)
    287          {
    288            uint8 extAddr[Z_EXTADDR_LEN];
    289          
    290            ZMacGetReq( ZMacExtAddr, extAddr );
    291          
    292            /* Build and send back the response */
    293            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), MT_SYS_GET_EXTADDR,
    294                                         Z_EXTADDR_LEN, extAddr);
    295          }
    296          
    297          /***************************************************************************************************
    298           * @fn      MT_SysOsalNVRead
    299           *
    300           * @brief  Read a NV value
    301           *
    302           * @param  uint8 pBuf - pointer to the data
    303           *
    304           * @return  None
    305           ***************************************************************************************************/
    306          void MT_SysOsalNVRead(uint8 *pBuf)
    307          {
    308            uint16 nvId;
    309            uint8 nvItemLen=0, nvItemOffset=0;
    310            uint8 *pRetBuf=NULL;
    311            uint8 respLen, cmdId;
    312          
    313            /* parse header */
    314            cmdId = pBuf[MT_RPC_POS_CMD1];
    315            pBuf += MT_RPC_FRAME_HDR_SZ;
    316          
    317            /* Get the ID */
    318            nvId = BUILD_UINT16(pBuf[0], pBuf[1]);
    319            pBuf += sizeof(uint16);
    320          
    321            /* Calculate the offset */
    322            nvItemOffset = *pBuf;
    323          
    324            nvItemLen = osal_nv_item_len(nvId);
    325          
    326            /* Return only 250 bytes max */
    327            if (nvItemLen > MT_NV_ITEM_MAX_LENGTH)
    328            {
    329              nvItemLen = MT_NV_ITEM_MAX_LENGTH;
    330            }
    331          
    332            if ((nvItemLen > 0) && ((nvItemLen - nvItemOffset) > 0))
    333            {
    334              respLen = nvItemLen - nvItemOffset + 2;
    335            }
    336            else
    337            {
    338              respLen = 2;
    339            }
    340          
    341            pRetBuf = osal_mem_alloc(respLen);
    342          
    343            if (pRetBuf != NULL)
    344            {
    345              osal_memset(pRetBuf, 0, respLen);
    346          
    347              /* Default to ZFailure */
    348              pRetBuf[0] = ZFailure;
    349          
    350              if (respLen > 2)
    351              {
    352                if (((osal_nv_read( nvId, (uint16)nvItemOffset, (uint16)nvItemLen, &pRetBuf[2])) == ZSUCCESS) && (respLen > 2))
    353                {
    354                  pRetBuf[0] = ZSuccess;
    355                }
    356                pRetBuf[1] = nvItemLen - nvItemOffset;
    357              }
    358              else
    359              {
    360                pRetBuf[1] = 0;
    361              }
    362          
    363              /* Build and send back the response */
    364              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), cmdId, respLen, pRetBuf );
    365          
    366              osal_mem_free(pRetBuf);
    367            }
    368          
    369          
    370          }
    371          
    372          /***************************************************************************************************
    373           * @fn      MT_SysOsalNVWrite
    374           *
    375           * @brief
    376           *
    377           * @param   uint8 pData - pointer to the data
    378           *
    379           * @return  None
    380           ***************************************************************************************************/
    381          void MT_SysOsalNVWrite(uint8 *pBuf)
    382          {
    383            uint16 nvId;
    384            uint8 nvItemLen=0, nvItemOffset=0;
    385            uint8 retValue, cmdId;
    386          
    387            /* parse header */
    388            cmdId = pBuf[MT_RPC_POS_CMD1];
    389            pBuf += MT_RPC_FRAME_HDR_SZ;
    390          
    391            /* Get the ID */
    392            nvId = BUILD_UINT16(pBuf[0], pBuf[1]);
    393            pBuf += sizeof(uint16);
    394          
    395            /* Calculate the offset */
    396            nvItemOffset = *pBuf++;
    397          
    398            /* Calculate the length */
    399            nvItemLen = *pBuf++;
    400          
    401            /* Default to ZFailure */
    402            retValue = ZFailure;
    403          
    404            /* Set the zGlobal value of this NV item. */
    405            zgSetItem( nvId, (uint16)nvItemLen, pBuf );
    406          
    407            if ((osal_nv_write( nvId, (uint16)nvItemOffset, (uint16)nvItemLen, pBuf)) == ZSUCCESS)
    408            {
    409              retValue = ZSuccess;
    410            }
    411          
    412            /* Build and send back the response */
    413            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), cmdId, 1, &retValue );
    414          }
    415          
    416          /***************************************************************************************************
    417           * @fn      MT_SysOsalStartTimer
    418           *
    419           * @brief
    420           *
    421           * @param   uint8 pData - pointer to the data
    422           *
    423           * @return  None
    424           ***************************************************************************************************/
    425          void MT_SysOsalStartTimer(uint8 *pBuf)
    426          {
    427            uint16 eventId;
    428            uint8 retValue = ZFailure;
    429            uint8 cmdId;
    430          
    431            /* parse header */
    432            cmdId = pBuf[MT_RPC_POS_CMD1];
    433            pBuf += MT_RPC_FRAME_HDR_SZ;
    434          
    435            if (*pBuf <= 3)
    436            {
    437              eventId = (uint16) MT_SysOsalEventId[*pBuf];
    438              retValue = osal_start_timerEx(MT_TaskID, eventId, BUILD_UINT16(pBuf[1], pBuf[2]));
    439            }
    440            else
    441            {
    442              retValue = ZInvalidParameter;
    443            }
    444          
    445            /* Build and send back the response */
    446            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), cmdId, 1, &retValue);
    447          }
    448          
    449          /***************************************************************************************************
    450           * @fn      MT_SysOsalStopTimer
    451           *
    452           * @brief
    453           *
    454           * @param   uint8 pData - pointer to the data
    455           *
    456           * @return  None
    457           ***************************************************************************************************/
    458          void MT_SysOsalStopTimer(uint8 *pBuf)
    459          {
    460            uint16 eventId;
    461            uint8 retValue = ZFailure;
    462            uint8 cmdId;
    463          
    464            /* parse header */
    465            cmdId = pBuf[MT_RPC_POS_CMD1];
    466            pBuf += MT_RPC_FRAME_HDR_SZ;
    467          
    468            if (*pBuf <= 3)
    469            {
    470              eventId = (uint16) MT_SysOsalEventId[*pBuf];
    471              retValue = osal_stop_timerEx(MT_TaskID, eventId);
    472            }
    473            else
    474            {
    475              retValue = ZInvalidParameter;
    476            }
    477          
    478            /* Build and send back the response */
    479            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), cmdId, 1, &retValue );
    480          }
    481          
    482          /***************************************************************************************************
    483           * @fn      MT_SysRandom
    484           *
    485           * @brief
    486           *
    487           * @param   uint8 pData - pointer to the data
    488           *
    489           * @return  None
    490           ***************************************************************************************************/
    491          void MT_SysRandom()
    492          {
    493            uint16 randValue = Onboard_rand();
    494            uint8 retArray[2];
    495          
    496            retArray[0] = LO_UINT16(randValue);
    497            retArray[1] = HI_UINT16(randValue);
    498          
    499            /* Build and send back the response */
    500            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), MT_SYS_RANDOM, 2, retArray );
    501          }
    502          
    503          /***************************************************************************************************
    504           * @fn      MT_SysAdcRead
    505           *
    506           * @brief   Reading ADC value, temperature sensor and voltage
    507           *
    508           * @param   uint8 pData - pointer to the data
    509           *
    510           * @return  None
    511           ***************************************************************************************************/
    512          void MT_SysAdcRead(uint8 *pBuf)
    513          {
    514            uint8 channel, resolution;
    515            uint16 tempValue;
    516            uint8 retArray[2];
    517            uint8 cmdId;
    518          
    519            /* parse header */
    520            cmdId = pBuf[MT_RPC_POS_CMD1];
    521            pBuf += MT_RPC_FRAME_HDR_SZ;
    522          
    523            /* Channel */
    524            channel = *pBuf++;
    525          
    526            /* Resolution */
    527            resolution = *pBuf++;
    528          
    529            /* Voltage reading */
    530            switch (channel)
    531            {
    532              /* Analog input channel */
    533              case HAL_ADC_CHANNEL_0:
    534              case HAL_ADC_CHANNEL_1:
    535              case HAL_ADC_CHANNEL_2:
    536              case HAL_ADC_CHANNEL_3:
    537              case HAL_ADC_CHANNEL_4:
    538              case HAL_ADC_CHANNEL_5:
    539              case HAL_ADC_CHANNEL_6:
    540              case HAL_ADC_CHANNEL_7:
    541                tempValue = HalAdcRead(channel, resolution);
    542                break;
    543          
    544              /* Temperature sensor */
    545              case(HAL_ADC_CHANNEL_TEMP):
    546                tempValue = HalAdcRead(HAL_ADC_CHANNEL_TEMP, HAL_ADC_RESOLUTION_14);
    547                break;
    548          
    549              /* Voltage reading */
    550              case(HAL_ADC_CHANNEL_VDD):
    551                tempValue = HalAdcRead(HAL_ADC_CHANNEL_VDD, HAL_ADC_RESOLUTION_14);
    552                break;
    553          
    554              default:
    555                break;
    556            }
    557          
    558            retArray[0] = LO_UINT16(tempValue);
    559            retArray[1] = HI_UINT16(tempValue);
    560          
    561            /* Build and send back the response */
    562            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), cmdId, 2, retArray);
    563          }
    564          
    565          /**************************************************************************************************
    566           * @fn      MT_SysGpio
    567           *
    568           * @brief   ZAccel RPC interface for controlling the available GPIO pins.
    569           *
    570           * @param   uint8 pData - Pointer to the data.
    571           *
    572           * @return  None
    573           *************************************************************************************************/
    574          void MT_SysGpio(uint8 *pBuf)
    575          {
    576            uint8 cmd, val;
    577          
    578            cmd = pBuf[MT_RPC_POS_CMD1];
    579            pBuf += MT_RPC_FRAME_HDR_SZ;
    580          
    581            /* Board specific GPIO goes here */
    582          
    583            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_SYS), cmd, 1, &val);
    584          }
    585          
    586          #endif /* MT_SYS_FUNC */
    587          
    588          /***************************************************************************************************
    589           * SUPPORT
    590           ***************************************************************************************************/
    591          
    592          /***************************************************************************************************
    593           * @fn      MT_SysResetInd()
    594           *
    595           * @brief   Sends a ZTOOL "reset response" message.
    596           *
    597           * @param   None
    598           *
    599           * @return  None
    600           *
    601           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    602          void MT_SysResetInd(void)
   \                     MT_SysResetInd:
    603          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 6
   \   000004   74FA         MOV     A,#-0x6
   \   000006   12....       LCALL   ?ALLOC_XSTACK8
    604            uint8 retArray[6];
    605          
    606            retArray[0] = ResetReason();   /* Reason */
   \   000009   E59D         MOV     A,0x9d
   \   00000B   13           RRC     A
   \   00000C   13           RRC     A
   \   00000D   13           RRC     A
   \   00000E   541F         ANL     A,#0x1f
   \   000010   5403         ANL     A,#0x3
   \   000012   85..82       MOV     DPL,?XSP + 0
   \   000015   85..83       MOV     DPH,?XSP + 1
   \   000018   F0           MOVX    @DPTR,A
    607            retArray[1] = 0x00;            /* Transport Revision */
   \   000019   7401         MOV     A,#0x1
   \   00001B   12....       LCALL   ?XSTACK_DISP0_8
   \   00001E   E4           CLR     A
   \   00001F   F0           MOVX    @DPTR,A
    608            retArray[2] = 0x00;            /* Product */
   \   000020   7402         MOV     A,#0x2
   \   000022   12....       LCALL   ?XSTACK_DISP0_8
   \   000025   E4           CLR     A
   \   000026   F0           MOVX    @DPTR,A
    609            retArray[3] = 0x00;            /* Major Revision */
   \   000027   7403         MOV     A,#0x3
   \   000029   12....       LCALL   ?XSTACK_DISP0_8
   \   00002C   E4           CLR     A
   \   00002D   F0           MOVX    @DPTR,A
    610            retArray[4] = 0x00;            /* Minor Revision */
   \   00002E   7404         MOV     A,#0x4
   \   000030   12....       LCALL   ?XSTACK_DISP0_8
   \   000033   E4           CLR     A
   \   000034   F0           MOVX    @DPTR,A
    611            retArray[5] = 0x00;            /* Hardware Revision */
   \   000035   7405         MOV     A,#0x5
   \   000037   12....       LCALL   ?XSTACK_DISP0_8
   \   00003A   E4           CLR     A
   \   00003B   F0           MOVX    @DPTR,A
    612          
    613            /* Send out Reset Response message */
    614            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_SYS), MT_SYS_RESET_IND,
    615                                          sizeof(retArray), retArray);
   \   00003C                ; Setup parameters for call to function MT_BuildAndSendZToolResponse
   \   00003C   85..82       MOV     DPL,?XSP + 0
   \   00003F   85..83       MOV     DPH,?XSP + 1
   \   000042   AC82         MOV     R4,DPL
   \   000044   AD83         MOV     R5,DPH
   \   000046   7B06         MOV     R3,#0x6
   \   000048   7A80         MOV     R2,#-0x80
   \   00004A   7941         MOV     R1,#0x41
   \   00004C   12....       LCALL   ??MT_BuildAndSendZToolResponse?relay
    616          }
   \   00004F   7406         MOV     A,#0x6
   \   000051   12....       LCALL   ?DEALLOC_XSTACK8
   \   000054   D083         POP     DPH
   \   000056   D082         POP     DPL
   \   000058   02....       LJMP    ?BRET
   \   00005B                REQUIRE SLEEPSTA
    617          
    618          /***************************************************************************************************
    619           * @fn      MT_SysOsalTimerExpired()
    620           *
    621           * @brief   Sends a SYS Osal Timer Expired
    622           *
    623           * @param   None
    624           *
    625           * @return  None
    626           *
    627           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    628          void MT_SysOsalTimerExpired(uint8 Id)
   \                     MT_SysOsalTimerExpired:
    629          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 1
   \   000005   74FF         MOV     A,#-0x1
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   E9           MOV     A,R1
    630            uint8 retValue;
    631            retValue = Id;
   \   00000B   85..82       MOV     DPL,?XSP + 0
   \   00000E   85..83       MOV     DPH,?XSP + 1
   \   000011   F0           MOVX    @DPTR,A
    632            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_SYS), MT_SYS_OSAL_TIMER_EXPIRED, 1, &retValue);
   \   000012                ; Setup parameters for call to function MT_BuildAndSendZToolResponse
   \   000012   AC82         MOV     R4,DPL
   \   000014   AD83         MOV     R5,DPH
   \   000016   7B01         MOV     R3,#0x1
   \   000018   7A81         MOV     R2,#-0x7f
   \   00001A   7941         MOV     R1,#0x41
   \   00001C   12....       LCALL   ??MT_BuildAndSendZToolResponse?relay
    633          }
   \   00001F   7401         MOV     A,#0x1
   \   000021   12....       LCALL   ?DEALLOC_XSTACK8
   \   000024   7F01         MOV     R7,#0x1
   \   000026   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_SysResetInd?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_SysResetInd

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_SysOsalTimerExpired?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_SysOsalTimerExpired
    634          
    635          /***************************************************************************************************
    636           ***************************************************************************************************/

   Maximum stack usage in bytes:

     Function                       ISTACK PSTACK XSTACK
     --------                       ------ ------ ------
     MT_SysOsalTimerExpired             1      0     10
       -> MT_BuildAndSendZToolResponse
                                        0      0     20
     MT_SysResetInd                     3      0      6
       -> MT_BuildAndSendZToolResponse
                                        4      0     12


   Segment part sizes:

     Function/Label                 Bytes
     --------------                 -----
     SLEEPSTA                          1
     MT_SysOsalEventId                 8
     MT_SysResetInd                   91
     MT_SysOsalTimerExpired           41
     ??MT_SysResetInd?relay            6
     ??MT_SysOsalTimerExpired?relay    6

 
 132 bytes in segment BANKED_CODE
  12 bytes in segment BANK_RELAYS
   1 byte  in segment SFR_AN
   8 bytes in segment XDATA_ROM_C
 
 144 bytes of CODE  memory
   8 bytes of CONST memory
   0 bytes of DATA  memory (+ 1 byte shared)

Errors: none
Warnings: none
